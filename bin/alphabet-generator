#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use DiceCipher\TableGenerator\UniqueAlphabetGenerator;

// Define CLI usage
if ($argc < 2) {
    echo "Usage: alphabet-generator <number_of_sequences> [output_file]\n";
    echo "  number_of_sequences: Number of unique sequences to generate\n";
    echo "  output_file: (optional) Output file name (default: alphabet-sequences.txt)\n";
    exit(1);
}

$numSequences = (int) $argv[1];
$outputFile = $argv[2] ?? 'alphabet-sequences.txt';

if ($numSequences <= 0) {
    echo "Error: The number of sequences must be a positive integer.\n";
    exit(1);
}

// Ensure output directory exists
$outputDir = __DIR__ . '/../output';
if (!is_dir($outputDir)) {
    mkdir($outputDir, 0755, true);
}

// Prepend output directory to the filename
$pathInfo = pathinfo($outputFile);
if ($pathInfo['dirname'] === '.' || empty($pathInfo['dirname'])) {
    // Relative path - prepend output directory
    $outputFile = $outputDir . '/' . basename($outputFile);
} else {
    // Absolute or relative path with directory - keep as is but ensure it's in output
    $outputFile = $outputDir . '/' . basename($outputFile);
}

// Read alphabet from master-alphabet.txt
$alphabetFile = __DIR__ . '/../resources/master-alphabet.txt';
if (!file_exists($alphabetFile)) {
    echo "Error: Alphabet file not found at: $alphabetFile\n";
    exit(1);
}

$alphabet = [];
$handle = fopen($alphabetFile, 'r');
if ($handle === false) {
    echo "Error: Could not open alphabet file.\n";
    exit(1);
}

$lineNumber = 0;
while (($line = fgets($handle)) !== false && $lineNumber < 40) {
    // Read the line and preserve it (don't trim yet, we want to check for empty lines)
    $originalLine = rtrim($line, "\r\n");
    // Only skip if the line is completely empty (no content at all)
    if ($originalLine !== '') {
        $alphabet[] = $originalLine;
        $lineNumber++;
    }
}
fclose($handle);

if (count($alphabet) !== 40) {
    echo "Error: Alphabet file must contain exactly 40 characters (one per line).\n";
    echo "Found " . count($alphabet) . " characters.\n";
    echo "Characters found: " . implode(", ", $alphabet) . "\n";
    exit(1);
}

// Run the sequence generator
$generator = new UniqueAlphabetGenerator($alphabet, $outputFile);
$generator->generateAndStore($numSequences);

echo "Successfully generated $numSequences sequences in $outputFile\n";

// Automatically run bias analysis
echo "\nRunning bias analysis for all characters...\n";
$analyzeScript = __DIR__ . '/analyze-alphabet-bias';
if (file_exists($analyzeScript)) {
    $command = escapeshellarg(PHP_BINARY) . ' ' . escapeshellarg($analyzeScript) . ' ' . 
               escapeshellarg($outputFile) . ' all';
    passthru($command, $returnCode);
    if ($returnCode === 0) {
        $pathInfo = pathinfo($outputFile);
        $reportFile = $pathInfo['dirname'] . '/' . $pathInfo['filename'] . '--bias-report-histogram.txt';
        echo "\nBias analysis complete! Report saved to: $reportFile\n";
    } else {
        echo "\nWarning: Bias analysis completed with errors (exit code: $returnCode)\n";
    }
} else {
    echo "\nWarning: Bias analysis script not found at: $analyzeScript\n";
}

